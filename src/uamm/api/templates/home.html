{% extends "base.html" %}
{% block content %}
<div class="card mb-3">
  <div class="card-body">
    <h3 class="mb-1">Welcome to UAMM</h3>
    <p id="home-hero-sub" class="text-muted mb-3">Choose a workspace to get started.</p>
    <div class="d-flex gap-2 flex-wrap">
      <a id="hero-open" class="btn btn-primary disabled" href="#" aria-disabled="true">Open Playground</a>
      <a id="hero-docs" class="btn btn-outline-secondary disabled" href="#" aria-disabled="true">Manage Docs</a>
      <a id="hero-steps" class="btn btn-outline-secondary disabled" href="#" aria-disabled="true">Recent Steps</a>
      <a class="btn btn-outline-secondary" href="/ui/workspaces">Manage Workspaces</a>
    </div>
  </div>
  </div>
<div class="row">
  <div class="col-lg-3">
    <div class="card mb-3">
      <div class="card-header d-flex align-items-center">
        <span>Workspaces</span>
        <button class="btn btn-sm btn-outline-secondary ms-auto" onclick="hsLoadWorkspaces()">Refresh</button>
      </div>
      <div class="list-group list-group-flush" id="hs-ws-list">
        <div class="list-group-item text-muted small">Loading…</div>
      </div>
      <div class="card-body d-grid gap-2">
        <button class="btn btn-sm btn-outline-success" onclick="hsCreateTest()">Create Test Workspace</button>
        <a class="btn btn-sm btn-outline-primary" href="/ui/workspaces">Advanced…</a>
      </div>
    </div>
  </div>
  <div class="col-lg-9">
    <div class="card mb-3">
      <div class="card-header">Quick Start</div>
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-md-9">
            <label class="form-label small">Question</label>
            <input id="hs-q" class="form-control" placeholder="Ask something…">
          </div>
          <div class="col-md-2">
            <label class="form-label small">Domain</label>
            <input id="hs-domain" class="form-control" placeholder="default" value="default">
          </div>
          <div class="col-md-1 d-grid">
            <button class="btn btn-primary" onclick="hsGoPlayground()">Go</button>
          </div>
        </div>
        <div class="mt-3">
          <a class="btn btn-sm btn-outline-secondary" href="/ui/rag">Manage Docs</a>
          <a class="btn btn-sm btn-outline-secondary" href="/ui/obs">Recent Steps</a>
          <a class="btn btn-sm btn-outline-secondary" href="/ui/cp">CP Thresholds</a>
          <a class="btn btn-sm btn-outline-secondary" href="/ui/evals">Evals & Tuning</a>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">Configuration</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Accept Threshold <span class="text-muted" data-bs-toggle="tooltip" title="Higher threshold makes the agent more conservative when accepting answers.">?</span></label>
            <input id="hs-thresh" class="form-range" type="range" min="0" max="1" step="0.01" value="0.85" oninput="hsSyncLabel('hs-thresh','hs-thresh-val')">
            <div class="small text-muted">Higher = more conservative accept.</div>
            <div><code id="hs-thresh-val">0.85</code></div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Borderline Δ <span class="text-muted" data-bs-toggle="tooltip" title="Wider delta triggers more refinements for borderline scores.">?</span></label>
            <input id="hs-delta" class="form-range" type="range" min="0" max="0.5" step="0.01" value="0.05" oninput="hsSyncLabel('hs-delta','hs-delta-val')">
            <div class="small text-muted">Wider Δ triggers more refinements.</div>
            <div><code id="hs-delta-val">0.05</code></div>
          </div>
          <div class="col-md-4">
            <label class="form-label">SNNE Samples <span class="text-muted" data-bs-toggle="tooltip" title="More samples produce smoother uncertainty estimation but cost more tokens.">?</span></label>
            <input id="hs-snne" class="form-range" type="range" min="1" max="10" step="1" value="5" oninput="hsSyncLabel('hs-snne','hs-snne-val')">
            <div class="small text-muted">More samples → smoother uncertainty.</div>
            <div><code id="hs-snne-val">5</code></div>
          </div>
        </div>
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-outline-primary" onclick="hsApplyConfig()">Apply (Global)</button>
          <a class="btn btn-outline-secondary" href="/ui/docs#evals">Learn more</a>
        </div>
        <div id="hs-config-status" class="small text-muted mt-2"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function hsSyncLabel(sliderId, labelId){
  const val = document.getElementById(sliderId).value;
  document.getElementById(labelId).textContent = val;
}

function updateHero(){
  try{
    const ws = (window.uammCtx && window.uammCtx.ws) || 'default';
    const sub = document.getElementById('home-hero-sub');
    const open = document.getElementById('hero-open');
    const docs = document.getElementById('hero-docs');
    const steps = document.getElementById('hero-steps');
    const hasWs = ws && ws !== 'default';
    if (sub) sub.textContent = hasWs ? `Current workspace: ${ws}` : 'Choose a workspace to get started.';
    const setBtn = (el, href, enable) => { if (!el) return; el.href = href; el.classList.toggle('disabled', !enable); el.setAttribute('aria-disabled', enable ? 'false' : 'true'); };
    setBtn(open, '/ui?ws=' + encodeURIComponent(ws), true);
    setBtn(docs, '/ui/rag?ws=' + encodeURIComponent(ws), true);
    setBtn(steps, '/ui/obs?ws=' + encodeURIComponent(ws), true);
  }catch(e){}
}

async function hsLoadWorkspaces(){
  const el = document.getElementById('hs-ws-list');
  el.innerHTML = '<div class="list-group-item text-muted small">Loading…</div>';
  try{
    const res = await ctxFetch('/workspaces');
    const data = await res.json();
    if(!res.ok) throw new Error('failed');
    const ws = data.workspaces || [];
    if(!ws.length){ el.innerHTML = '<div class="list-group-item small">No workspaces yet. Create one.</div>'; return; }
    el.innerHTML = ws.map(w => `<button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="hsSelect('${w.slug}')">${escapeHtml(w.slug)}<span class="badge text-bg-light">${escapeHtml(w.name||'')}</span></button>`).join('');
  } catch(e){ el.innerHTML = '<div class="list-group-item text-danger small">Error</div>'; }
}
function hsSelect(slug){ window.uammCtx.ws = slug; localStorage.setItem('uamm.ws', slug); if (window.ctxLoadStats) window.ctxLoadStats(); updateHero(); showToast('Workspace set: ' + slug); }
async function hsCreateTest(){
  const slug = 'test-' + Math.random().toString(36).slice(2,8);
  try{
    const res = await ctxFetch('/workspaces', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({slug, name: 'Test '+slug})});
    const data = await res.json();
    if(!res.ok) throw new Error(data.error||'failed');
    hsSelect(slug);
    hsLoadWorkspaces();
  } catch(e){ showToast('Failed to create'); }
}
function hsGoPlayground(){
  const q = document.getElementById('hs-q').value.trim();
  const dom = document.getElementById('hs-domain').value.trim() || 'default';
  const ws = (window.uammCtx && window.uammCtx.ws) || 'default';
  const params = new URLSearchParams({ ws, domain: dom });
  if (q) { params.set('q', q); params.set('autostart','1'); }
  const url = '/ui?' + params.toString();
  window.location.href = url;
}
async function hsApplyConfig(){
  const body = {
    changes: {
      accept_threshold: parseFloat(document.getElementById('hs-thresh').value),
      borderline_delta: parseFloat(document.getElementById('hs-delta').value),
      snne_samples: parseInt(document.getElementById('hs-snne').value)
    }
  };
  const el = document.getElementById('hs-config-status');
  el.textContent = 'Applying…';
  try{
    const res = await ctxFetch('/settings', {method:'PATCH', headers:{'content-type':'application/json'}, body: JSON.stringify(body)});
    const data = await res.json();
    if(!res.ok) throw new Error('failed');
    el.textContent = 'Applied: ' + JSON.stringify(data.applied);
  } catch(e){ el.textContent = 'Error applying settings'; }
}
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
document.addEventListener('DOMContentLoaded', () => { hsLoadWorkspaces(); updateHero(); });
// Load global settings into sliders for clarity
document.addEventListener('DOMContentLoaded', async () => {
  try{
    const res = await ctxFetch('/settings');
    const data = await res.json();
    if (!res.ok) throw new Error('failed');
    const s = data.settings || {};
    const th = document.getElementById('hs-thresh'); if (th) { th.value = s.accept_threshold ?? 0.85; hsSyncLabel('hs-thresh','hs-thresh-val'); }
    const dl = document.getElementById('hs-delta'); if (dl) { dl.value = s.borderline_delta ?? 0.05; hsSyncLabel('hs-delta','hs-delta-val'); }
    const sn = document.getElementById('hs-snne'); if (sn) { sn.value = s.snne_samples ?? 5; hsSyncLabel('hs-snne','hs-snne-val'); }
  }catch(e){ /* ignore */ }
});
</script>
{% endblock %}
