{% extends "base.html" %}
{% block content %}
<nav class="breadcrumb-wrap" aria-label="breadcrumb">
  <ol class="breadcrumb mb-2">
    <li class="breadcrumb-item"><a href="/ui/home">Home</a></li>
    <li class="breadcrumb-item active" aria-current="page">Evals & Tuning</li>
  </ol>
</nav>
<div class="row">
  <div class="col-lg-6">
    <div class="card mb-3">
      <div class="card-header d-flex align-items-center">
        <span>Run Suites</span>
        <button class="btn btn-sm btn-outline-secondary ms-auto" onclick="loadSuites()">Load Suites</button>
      </div>
      <div class="card-body">
        <div id="suites" class="small text-muted">Loading…</div>
        <div class="form-check form-switch mt-2">
          <input class="form-check-input" type="checkbox" role="switch" id="update-cp" checked>
          <label class="form-check-label" for="update-cp">Update CP reference</label>
        </div>
        <div class="mt-2"><input id="admin-key-e" type="password" class="form-control" placeholder="Admin API Key (optional)"></div>
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-primary" onclick="runSuites()">Run Selected</button>
        </div>
        <div class="mt-3" id="suite-result"></div>
      </div>
    </div>
    <div class="card mb-3">
      <div class="card-header">Tuner</div>
      <div class="card-body">
        <div class="row g-2">
          <div class="col-md-6"><input id="target-accept" class="form-control" placeholder="accept_min (e.g., 0.65)"></div>
          <div class="col-md-6"><input id="target-abstain" class="form-control" placeholder="abstain_max (e.g., 0.35)"></div>
          <div class="col-md-6"><input id="target-false" class="form-control" placeholder="false_accept_max (e.g., 0.05)"></div>
          <div class="col-md-6"><input id="target-lat" class="form-control" placeholder="latency_p95_max (s, e.g., 2.5)"></div>
        </div>
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-outline-primary" onclick="proposeTuning()">Propose</button>
          <button class="btn btn-outline-success" onclick="applyTuning()" id="btn-apply" disabled>Apply</button>
        </div>
        <div class="mt-2" id="tuner-proposal"></div>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card mb-3">
      <div class="card-header">Ad-hoc Items</div>
      <div class="card-body">
        <div id="items" class="mb-2"></div>
        <div class="d-flex gap-2 mb-2">
          <button class="btn btn-sm btn-outline-secondary" onclick="addItem()">Add</button>
          <button class="btn btn-sm btn-outline-danger" onclick="clearItems()">Clear</button>
        </div>
        <div class="row g-2">
          <div class="col-md-4"><input id="adhoc-ref" class="form-control" placeholder="max_refinements" value="1"></div>
          <div class="col-md-4"><input id="adhoc-turn" class="form-control" placeholder="tool_budget_per_turn" value="2"></div>
          <div class="col-md-4"><input id="adhoc-refb" class="form-control" placeholder="tool_budget_per_refinement" value="2"></div>
        </div>
        <div class="form-check form-switch mt-2">
          <input class="form-check-input" type="checkbox" role="switch" id="adhoc-cp" checked>
          <label class="form-check-label" for="adhoc-cp">Enable CP + use CP decision</label>
        </div>
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-outline-primary" onclick="runAdhoc()">Run Ad-hoc</button>
        </div>
        <div class="mt-3" id="adhoc-result"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-header d-flex align-items-center">
        <span>Recent Runs</span>
        <button class="btn btn-sm btn-outline-secondary ms-auto" onclick="loadRuns()">Refresh</button>
      </div>
      <div class="card-body"><div id="runs" class="small text-muted">Loading…</div></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let lastProposalId = null;

async function loadSuites(){
  const el = document.getElementById('suites');
  el.textContent = 'Loading…';
  try {
    const res = await ctxFetch('/evals/suites');
    const data = await res.json();
    if (!res.ok) throw new Error('failed');
    const suites = data.suites || [];
    if (!suites.length) { el.textContent = 'No suites'; return; }
    el.innerHTML = suites.map(s => `
      <div class="form-check">
        <input class="form-check-input suite-select" type="checkbox" id="suite-${s.id}" value="${s.id}">
        <label class="form-check-label" for="suite-${s.id}"><strong>${escapeHtml(s.id)}</strong> — ${escapeHtml(s.label)} <span class="text-muted">[${escapeHtml(s.category)}]</span></label>
        <div class="small text-muted">${escapeHtml(s.description)}</div>
      </div>
    `).join('');
  } catch(e){ el.textContent = 'Error loading suites'; }
}

async function runSuites(){
  const ids = Array.from(document.querySelectorAll('.suite-select:checked')).map(el => el.value);
  if (!ids.length) { showToast('Select one or more suites'); return; }
  const update_cp = document.getElementById('update-cp').checked;
  const key = document.getElementById('admin-key-e').value.trim();
  const out = document.getElementById('suite-result');
  out.textContent = 'Running…';
  try {
    const res = await ctxFetch('/evals/run', {
      method: 'POST',
      headers: Object.assign({'content-type':'application/json'}, key?{'Authorization':'Bearer '+key}:{}) ,
      body: JSON.stringify({ suite_ids: ids, update_cp })
    });
    const data = await res.json();
    if (!res.ok) throw new Error('failed');
    const suites = data.suites || [];
    out.innerHTML = `<div class="small text-muted">run_id ${escapeHtml(data.run_id||'')}</div>` +
      '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Suite</th><th>Accept</th><th>False Accept</th><th>Accuracy</th><th>Avg S</th></tr></thead><tbody>' +
      suites.map(s => {
        const m = s.metrics||{};
        return `<tr><td>${escapeHtml(s.suite_id||'')}</td><td>${fmtPct(m.accept_rate)}</td><td>${fmtPct(m.false_accept_rate)}</td><td>${fmtPct(m.accuracy)}</td><td>${fmtNum(m.avg_score)}</td></tr>`;
      }).join('') + '</tbody></table></div>';
  } catch(e){ out.textContent = 'Error running suites'; }
}

function addItem(){
  const wrap = document.getElementById('items');
  const idx = wrap.children.length + 1;
  const div = document.createElement('div');
  div.className = 'border rounded p-2 mb-2';
  div.innerHTML = `
    <div class="row g-2 align-items-end">
      <div class="col-md-8"><label class="form-label small">Question</label><input class="form-control item-q"></div>
      <div class="col-md-2"><label class="form-label small">Domain</label><input class="form-control item-dom" placeholder="default"></div>
      <div class="col-md-2"><div class="form-check"><input class="form-check-input item-ok" type="checkbox" id="ok-${idx}"><label class="form-check-label" for="ok-${idx}">Correct</label></div></div>
    </div>`;
  wrap.appendChild(div);
}
function clearItems(){ document.getElementById('items').innerHTML=''; }

async function runAdhoc(){
  const cards = Array.from(document.querySelectorAll('#items .border'));
  if (!cards.length) { showToast('Add at least one item'); return; }
  const items = cards.map(c => ({
    question: c.querySelector('.item-q').value.trim(),
    domain: c.querySelector('.item-dom').value.trim() || 'default',
    correct: c.querySelector('.item-ok').checked
  }));
  const body = {
    items,
    max_refinements: parseInt(document.getElementById('adhoc-ref').value || '0'),
    tool_budget_per_turn: parseInt(document.getElementById('adhoc-turn').value || '0'),
    tool_budget_per_refinement: parseInt(document.getElementById('adhoc-refb').value || '0'),
    cp_enabled: document.getElementById('adhoc-cp').checked,
    use_cp_decision: document.getElementById('adhoc-cp').checked
  };
  const out = document.getElementById('adhoc-result');
  out.textContent = 'Running…';
  try {
    const res = await ctxFetch('/evals/run', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body)});
    const data = await res.json();
    if (!res.ok) throw new Error('failed');
    const m = data.metrics||{};
    out.innerHTML = `<div class="small text-muted">run_id ${escapeHtml(data.run_id||'')}</div>
      <div><strong>Accept</strong> ${fmtPct(m.accept_rate)} • <strong>False Accept</strong> ${fmtPct(m.false_accept_rate)} • <strong>Accuracy</strong> ${fmtPct(m.accuracy)} • <strong>Avg S</strong> ${fmtNum(m.avg_score)}</div>`;
    if ((data.records||[]).length) {
      out.innerHTML += '<div class="table-responsive mt-2"><table class="table table-sm"><thead><tr><th>Domain</th><th>S</th><th>Accepted</th><th>Correct</th><th>CP</th><th>Tools</th><th>Plan+</th><th>Faith</th></tr></thead><tbody>' +
        data.records.map(r => `<tr><td>${escapeHtml(r.domain||'')}</td><td>${fmtNum(r.S)}</td><td>${r.accepted}</td><td>${r.correct}</td><td>${r.cp_accept===null?'n/a':r.cp_accept}</td><td>${r.tools||0}</td><td>${r.planning_improved||false}</td><td>${r.faithfulness===null?'n/a':fmtNum(r.faithfulness)}</td></tr>`).join('') + '</tbody></table></div>';
    }
  } catch(e){ out.textContent = 'Error running ad-hoc'; }
}

async function loadRuns(){
  const el = document.getElementById('runs');
  el.textContent = 'Loading…';
  try {
    const res = await ctxFetch('/evals/runs');
    const data = await res.json();
    if (!res.ok) throw new Error('failed');
    const runs = data.runs || [];
    if (!runs.length) { el.textContent = 'No runs'; return; }
    el.innerHTML = '<ul class="list-unstyled mb-0">' + runs.map(r => {
      const d = new Date((r.ts||0)*1000);
      return `<li class="mb-2"><code>${escapeHtml(r.run_id)}</code> — suites ${r.suites} — <span class="text-muted">${d.toLocaleString()}</span> <button class="btn btn-sm btn-outline-secondary ms-2" onclick="viewRun('${encodeURIComponent(r.run_id)}')">View</button></li>`;
    }).join('') + '</ul>';
  } catch(e){ el.textContent = 'Error loading runs'; }
}

async function viewRun(runId){
  const out = document.getElementById('suite-result');
  out.textContent = 'Loading…';
  try {
    const res = await ctxFetch('/evals/report/' + runId);
    const data = await res.json();
    if (!res.ok) throw new Error('failed');
    const suites = data.suites || [];
    if (!suites.length) { out.textContent = 'Run empty'; return; }
    out.innerHTML = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Suite</th><th>Accept</th><th>False Accept</th><th>Accuracy</th><th>Avg S</th></tr></thead><tbody>' +
      suites.map(s => {
        const m = s.metrics||{};
        return `<tr><td>${escapeHtml(s.suite_id||'custom')}</td><td>${fmtPct(m.accept_rate)}</td><td>${fmtPct(m.false_accept_rate)}</td><td>${fmtPct(m.accuracy)}</td><td>${fmtNum(m.avg_score)}</td></tr>`;
      }).join('') + '</tbody></table></div>';
  } catch(e){ out.textContent = 'Error loading run'; }
}

async function proposeTuning(){
  const ids = Array.from(document.querySelectorAll('.suite-select:checked')).map(el => el.value);
  if (!ids.length) { showToast('Select one or more suites'); return; }
  const body = { suite_ids: ids, targets: {} };
  const a = parseFloat(document.getElementById('target-accept').value || ''); if (!isNaN(a)) body.targets.accept_min = a;
  const b = parseFloat(document.getElementById('target-abstain').value || ''); if (!isNaN(b)) body.targets.abstain_max = b;
  const c = parseFloat(document.getElementById('target-false').value || ''); if (!isNaN(c)) body.targets.false_accept_max = c;
  const l = parseFloat(document.getElementById('target-lat').value || ''); if (!isNaN(l)) body.targets.latency_p95_max = l;
  const out = document.getElementById('tuner-proposal');
  out.textContent = 'Proposing…';
  try {
    const res = await ctxFetch('/tuner/propose', { method: 'POST', headers: {'content-type':'application/json'}, body: JSON.stringify(body) });
    const data = await res.json();
    if (!res.ok) throw new Error('failed');
    lastProposalId = data.proposal_id;
    document.getElementById('btn-apply').disabled = !lastProposalId;
    const patch = (data.proposal||{}).config_patch || {};
    const canary = data.canary || [];
    out.innerHTML = '<div><strong>Proposal</strong></div><pre class="small">' + escapeHtml(JSON.stringify(patch, null, 2)) + '</pre>' +
      '<div><strong>Canary</strong></div><pre class="small">' + escapeHtml(JSON.stringify(canary, null, 2)) + '</pre>';
  } catch(e){ out.textContent = 'Error proposing'; }
}

async function applyTuning(){
  if (!lastProposalId) { showToast('No proposal to apply'); return; }
  try {
    const res = await ctxFetch('/tuner/apply', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({proposal_id: lastProposalId, approved: true}) });
    const data = await res.json();
    if (!res.ok) throw new Error('failed');
    showToast('Applied proposal ' + lastProposalId);
  } catch(e){ showToast('Failed to apply'); }
}

function fmtPct(v){ return (typeof v === 'number') ? (v*100).toFixed(1)+'%' : 'n/a'; }
function fmtNum(v){ return (typeof v === 'number') ? v.toFixed(3) : 'n/a'; }
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

document.addEventListener('DOMContentLoaded', () => { loadSuites(); loadRuns(); addItem(); });
</script>
{% endblock %}
