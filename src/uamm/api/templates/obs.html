{% extends "base.html" %}
{% block content %}
<nav class="breadcrumb-wrap" aria-label="breadcrumb">
  <ol class="breadcrumb mb-2">
    <li class="breadcrumb-item"><a href="/ui/home">Home</a></li>
    <li class="breadcrumb-item active" aria-current="page">Steps & Metrics</li>
  </ol>
</nav>
<div class="row">
  <div class="col-lg-5">
    <div class="card mb-3">
      <div class="card-header d-flex align-items-center gap-2 flex-wrap">
        <span>Metrics</span>
        <div class="ms-auto d-flex align-items-center gap-2">
          <div class="input-group input-group-sm" style="width: 220px;">
            <span class="input-group-text">Auto</span>
            <select id="auto-interval" class="form-select" onchange="setAutoRefresh()">
              <option value="0">Off</option>
              <option value="5000">5s</option>
              <option value="15000">15s</option>
              <option value="60000">60s</option>
            </select>
          </div>
          <button class="btn btn-sm btn-outline-secondary" onclick="loadMetrics()">Refresh</button>
        </div>
      </div>
      <div class="card-body">
        <div id="metrics" class="small text-muted">Loading…</div>
        <div id="alerts" class="mt-2"></div>
      </div>
    </div>
  </div>
  <div class="col-lg-7">
    <div class="card mb-3">
      <div class="card-header d-flex align-items-center gap-2 flex-wrap">
        <span>Recent Steps</span>
        <div class="ms-auto d-flex gap-2 align-items-center flex-wrap">
          <input type="text" id="filter-domain" class="form-control form-control-sm" list="domain-list" placeholder="domain (optional)" style="width: 160px;" />
          <datalist id="domain-list"></datalist>
          <select id="filter-action" class="form-select form-select-sm" style="width: 140px;">
            <option value="">action (any)</option>
            <option>accept</option>
            <option>iterate</option>
            <option>abstain</option>
          </select>
          <input type="number" id="limit" class="form-control form-control-sm" value="50" style="width: 80px;" />
          <button class="btn btn-sm btn-outline-primary" onclick="loadSteps()">Refresh</button>
          <button class="btn btn-sm btn-outline-success" onclick="copySelectedPack()">Copy Selected</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="clearFilters()">Clear</button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle">
            <thead>
              <tr class="text-nowrap">
                <th><input class="form-check-input" type="checkbox" onchange="toggleAll(this)"></th>
                <th>Time</th><th>Domain</th><th>Action</th><th>S1</th><th>S2</th><th>S</th><th>CP</th><th></th>
              </tr>
            </thead>
            <tbody id="steps-body"></tbody>
          </table>
        </div>
        <div class="small text-muted" id="steps-summary"></div>
      </div>
    </div>
  </div>
</div>

<!-- Offcanvas for step details -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="stepDetail" aria-labelledby="stepDetailLabel">
  <div class="offcanvas-header">
    <h5 id="stepDetailLabel">Step Details</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <div id="step-summary" class="mb-2 small text-muted"></div>
    <pre id="step-json" class="small"></pre>
  </div>
  <div class="offcanvas-footer border-top p-2">
    <button class="btn btn-sm btn-outline-secondary" onclick="copyStepJson()">Copy JSON</button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let autoRefreshId = null;

async function loadMetrics() {
  const el = document.getElementById('metrics');
  el.textContent = 'Loading…';
  try {
    const res = await ctxFetch('/metrics');
    const m = await res.json();
    if (!res.ok) throw new Error('failed');
    const counts = `requests ${m.requests||0}, answers ${m.answers||0}, accept ${m.accept||0}, iterate ${m.iterate||0}, abstain ${m.abstain||0}`;
    const rates = m.rates ? `accept ${(m.rates.accept*100).toFixed(1)}%, iterate ${(m.rates.iterate*100).toFixed(1)}%, abstain ${(m.rates.abstain*100).toFixed(1)}%` : 'rates n/a';
    const lat = m.latency ? `p95 ${(m.latency.p95 ?? 'n/a')}s, avg ${(m.latency.average ?? 'n/a')}s (${m.latency.count} samples)` : 'latency n/a';
    const alerts = m.alerts ? Object.keys(m.alerts).length + ' categories' : 'none';
    el.innerHTML = `
      <div><strong>Counts</strong>: ${counts}</div>
      <div><strong>Rates</strong>: ${rates}</div>
      <div><strong>Latency</strong>: ${lat}</div>
      <div><strong>Alerts</strong>: ${alerts}</div>
    `;
    renderAlerts(m.alerts||{});
    renderDomainList(m.by_domain||{});
  } catch (e) {
    el.innerHTML = '<span class="text-danger">Error loading metrics</span>';
  }
}

async function loadSteps() {
  const tbody = document.getElementById('steps-body');
  const limit = parseInt(document.getElementById('limit').value || '50');
  const dom = document.getElementById('filter-domain').value.trim();
  const act = document.getElementById('filter-action').value.trim();
  tbody.innerHTML = '<tr><td colspan="8" class="text-muted">Loading…</td></tr>';
  try {
    const params = {limit};
    if (dom) params.domain = dom;
    if (act) params.action = act;
    const res = await ctxFetch('/steps/recent?' + new URLSearchParams(params));
    const data = await res.json();
    if (!res.ok) throw new Error('failed');
    const steps = data.steps || [];
    if (!steps.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-muted">No steps</td></tr>'; document.getElementById('steps-summary').textContent='0 step(s)'; return; }
    tbody.innerHTML = steps.map(s => {
      const d = new Date((s.ts || 0) * 1000);
      const when = isNaN(d.getTime()) ? '' : d.toLocaleTimeString();
      const cp = s.cp_accept ? '✓' : '✗';
      const s1 = (s.s1 ?? '').toString().slice(0,5);
      const s2 = (s.s2 ?? '').toString().slice(0,5);
      const S = (s.final_score ?? '').toString().slice(0,5);
      return `<tr>
        <td><input class="form-check-input step-select" type="checkbox" value="${s.id}"></td>
        <td class="text-nowrap">${when}</td>
        <td>${escapeHtml(s.domain||'')}</td>
        <td><span class="badge text-bg-${badgeForAction(s.action)}">${escapeHtml(s.action||'')}</span></td>
        <td>${s1}</td>
        <td>${s2}</td>
        <td>${S}</td>
        <td>${cp}</td>
        <td class="text-end"><button class="btn btn-sm btn-outline-secondary" onclick="viewStep('${s.id}')">View</button></td>
      </tr>`;
    }).join('');
    document.getElementById('steps-summary').textContent = `${steps.length} step(s)` + (dom?` • domain=${dom}`:'') + (act?` • action=${act}`:'');
  } catch (e) {
    tbody.innerHTML = '<tr><td colspan="8" class="text-danger">Error</td></tr>';
  }
}

async function viewStep(id) {
  try {
    const res = await ctxFetch('/steps/' + encodeURIComponent(id));
    const data = await res.json();
    if (!res.ok) throw new Error('failed');
    const sum = `action ${data.action}, domain ${data.domain}, S ${(data.final_score ?? '')}`;
    document.getElementById('step-summary').textContent = sum;
    document.getElementById('step-json').textContent = JSON.stringify(data, null, 2);
    const off = new bootstrap.Offcanvas(document.getElementById('stepDetail'));
    off.show();
  } catch (e) {
    showToast('Failed to load step ' + id);
  }
}

function escapeHtml(s) {
  return (s||'').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
}
function badgeForAction(a) {
  switch((a||'').toLowerCase()){
    case 'accept': return 'success';
    case 'iterate': return 'warning';
    case 'abstain': return 'secondary';
    default: return 'light';
  }
}
function copyStepJson() {
  const txt = document.getElementById('step-json').textContent || '';
  navigator.clipboard.writeText(txt);
}

function setAutoRefresh() {
  const sel = document.getElementById('auto-interval');
  if (!sel) return;
  const ms = parseInt(sel.value || '0');
  if (autoRefreshId) {
    clearInterval(autoRefreshId);
    autoRefreshId = null;
  }
  if (ms > 0) {
    autoRefreshId = setInterval(() => { loadMetrics(); loadSteps(); }, ms);
  }
}

function clearFilters() {
  const fd = document.getElementById('filter-domain');
  const fa = document.getElementById('filter-action');
  if (fd) fd.value = '';
  if (fa) fa.value = '';
  loadSteps();
}

function renderAlerts(alerts) {
  const el = document.getElementById('alerts');
  if (!el) return;
  if (!alerts || typeof alerts !== 'object' || !Object.keys(alerts).length) {
    el.innerHTML = '<span class="badge text-bg-success">No alerts</span>';
    return;
  }
  const order = ['latency','abstain','cp','approvals'];
  const color = { latency: 'warning', abstain: 'warning', cp: 'info', approvals: 'info' };
  const html = order.filter(k => alerts[k]).map(k => {
    const scope = alerts[k];
    const count = (scope && typeof scope === 'object') ? Object.keys(scope).length : 1;
    return `<span class="badge me-1 text-bg-${color[k]||'secondary'}">${k} ${count}</span>`;
  }).join('');
  el.innerHTML = html || '<span class="badge text-bg-success">No alerts</span>';
}

function renderDomainList(byDomain) {
  const dl = document.getElementById('domain-list');
  if (!dl) return;
  const keys = Object.keys(byDomain || {});
  dl.innerHTML = keys.map(k => `<option value="${escapeHtml(k)}">`).join('');
}

function toggleAll(cb) {
  document.querySelectorAll('.step-select').forEach(el => { el.checked = cb.checked; });
}

async function copySelectedPack() {
  const ids = Array.from(document.querySelectorAll('.step-select:checked')).map(el => el.value);
  if (!ids.length) { showToast('No steps selected'); return; }
  try {
    const cases = [];
    for (const id of ids) {
      const res = await fetch('/steps/' + encodeURIComponent(id));
      const st = await res.json();
      if (!res.ok) continue;
      const item = {
        id: st.id,
        domain: st.domain,
        action: st.action,
        s1: st.s1,
        s2: st.s2,
        S: st.final_score,
        cp_accept: st.cp_accept,
        issues: st.issues,
        tools_used: st.tools_used,
        question: st.question,
        answer: st.answer,
        trace: st.trace
      };
      cases.push(item);
    }
    const pack = { generated_at: new Date().toISOString(), count: cases.length, cases };
    await navigator.clipboard.writeText(JSON.stringify(pack, null, 2));
    showToast('Copied ' + cases.length + ' case(s)');
  } catch (e) {
    showToast('Failed to copy selection');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  loadMetrics();
  loadSteps();
  setAutoRefresh();
  try{
    const p = new URLSearchParams(window.location.search);
    const open = p.get('open_step');
    if (open) setTimeout(()=>viewStep(open), 300);
  }catch(e){}
});
</script>
{% endblock %}
